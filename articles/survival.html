<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Survival Analysis with episodes and tidymodels • episodes</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Survival Analysis with episodes and tidymodels">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">episodes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/survival.html">Survival Analysis with episodes and tidymodels</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dylanpieper/episodes" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Survival Analysis with episodes and tidymodels</h1>
            
      

      <div class="d-none name"><code>survival.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The {episodes} package segments longitudinal data into meaningful
episodes based on temporal gaps and variable changes. It’s designed for
analyzing treatment patterns, patient journeys, and other time series
data where interruptions and changes in covariates are important to
model.</p>
<p>This vignette demonstrates how to apply these features to survival
analysis using {tidymodels} to run Cox proportional hazards models with
both fixed and time-varying covariates. I will be using the simulated
<code>substance_use</code> dataset included in the package.</p>
</div>
<div class="section level2">
<h2 id="required-packages">Required Packages<a class="anchor" aria-label="anchor" href="#required-packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dylanpieper/episodes" class="external-link">episodes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/censored" class="external-link">censored</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pharmaverse/ggsurvfit" class="external-link">ggsurvfit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">surv_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/proportional_hazards.html" class="external-link">proportional_hazards</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"survival"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="time-to-discontinuation-analysis">Time to Discontinuation Analysis<a class="anchor" aria-label="anchor" href="#time-to-discontinuation-analysis"></a>
</h2>
<div class="section level3">
<h3 id="creating-episodes-with-fixed-covariates">Creating Episodes with Fixed Covariates<a class="anchor" aria-label="anchor" href="#creating-episodes-with-fixed-covariates"></a>
</h3>
<p>Our first example examines time to treatment discontinuation, using a
fixed-effects approach where covariates are considered constant
throughout the episode.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">episodes_fixed</span> <span class="op">&lt;-</span> <span class="va">substance_use</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/segment_episodes.html">segment_episodes</a></span><span class="op">(</span></span>
<span>    date_col <span class="op">=</span> <span class="va">visit_date</span>,</span>
<span>    gap_threshold <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    gap_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_result</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">episode_days</span>, <span class="va">discontinued</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">substance</span> <span class="op">+</span> <span class="va">medication</span> <span class="op">+</span> <span class="va">mental_health_disorder</span> <span class="op">+</span></span>
<span>      <span class="va">died_ever</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">surv_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">episodes_fixed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, conf.level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_result</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 17 × 7</span></span></span>
<span><span class="co">#&gt;    term                estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> age                    1.00    8.44<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>    0.708   4.79<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.999     1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mental_health_diso…    0.689   2.41<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  -<span style="color: #BB0000;">15.5</span>     5.24<span style="color: #949494;">e</span><span style="color: #BB0000;">-54</span>    0.657     0.722</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mental_health_diso…   <span style="color: #BB0000;">NA</span>       0   <span style="color: #949494;"> </span>     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> died_everTRUE          1.40    2.69<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   12.4     1.94<span style="color: #949494;">e</span><span style="color: #BB0000;">-35</span>    1.32      1.47 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> `cluster(client_id…    1.00    7.96<span style="color: #949494;">e</span><span style="color: #BB0000;">-6</span>    0.598   5.50<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    1.00      1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> genderFemale           1.02    2.33<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    0.833   4.05<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.974     1.07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> genderNon-binary       1.11    6.01<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    1.67    9.50<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    0.983     1.24 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> raceBlack              1.02    3.28<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    0.483   6.29<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.953     1.08 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> raceHispanic           0.974   3.28<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">0.797</span>   4.25<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.914     1.04 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> raceAsian              0.920   5.32<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">1.57</span>    1.17<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.829     1.02 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> raceOther              1.06    5.47<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    1.00    3.17<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.949     1.18 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> substanceOpiates       1.15    4.24<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    3.39    7.03<span style="color: #949494;">e</span><span style="color: #BB0000;">- 4</span>    1.06      1.25 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> medicationDisulfir…    0.940   4.25<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">1.45</span>    1.46<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.865     1.02 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> medicationAcampros…    0.988   3.87<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">0.309</span>   7.57<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.916     1.07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> medicationNaltrexo…    0.973   3.69<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">0.741</span>   4.59<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.905     1.05 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> medicationMethadone    1.01    5.95<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    0.153   8.78<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.898     1.13 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> medicationBuprenor…    0.996   5.62<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">0.073</span><span style="color: #BB0000; text-decoration: underline;">5</span>  9.41<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.892     1.11</span></span></code></pre></div>
<div class="section level4">
<h4 id="interpreting-the-results">Interpreting the Results<a class="anchor" aria-label="anchor" href="#interpreting-the-results"></a>
</h4>
<p>The model results show hazard ratios (HR) for each variable, where: -
HR &lt; 1: Reduced risk of discontinuation (better retention) - HR &gt;
1: Increased risk of discontinuation (worse retention) - HR = 1: No
effect on discontinuation risk</p>
<p>Key findings:</p>
<ul>
<li><p><strong>Mental health disorder</strong>: Clients with mental
health disorders have significantly better retention (HR = 0.689, 95%
CI: 0.657-0.722), indicating a 31.1% reduction in discontinuation
risk.</p></li>
<li><p><strong>Mortality</strong>: Clients who died have a 40% higher
risk of treatment discontinuation (HR = 1.40, 95% CI:
1.32-1.47).</p></li>
<li><p><strong>Substance type</strong>: Opiate users have a 15% higher
risk of discontinuation compared to alcohol users (HR = 1.15, 95% CI:
1.06-1.25).</p></li>
<li><p><strong>Demographics</strong>: Age, gender, and race show minimal
effects on treatment retention in this model.</p></li>
<li><p><strong>Medications</strong>: None of the medications show
statistically significant effects on retention, though point estimates
suggest small protective effects for most treatments.</p></li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="visualizing-survival-by-mental-health-disorder-status">Visualizing Survival by Mental Health Disorder Status<a class="anchor" aria-label="anchor" href="#visualizing-survival-by-mental-health-disorder-status"></a>
</h3>
<p>We can visualize these differences with Kaplan-Meier curves:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_curves</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">episode_days</span>, <span class="va">discontinued</span><span class="op">)</span> <span class="op">~</span> <span class="va">mental_health_disorder</span>,</span>
<span>  data <span class="op">=</span> <span class="va">episodes_fixed</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/ggsurvfit.html" class="external-link">ggsurvfit</a></span><span class="op">(</span><span class="va">surv_curves</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_confidence_interval.html" class="external-link">add_confidence_interval</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_risktable.html" class="external-link">add_risktable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Days"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Probability of Retention"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Kaplan-Meier Curves by Mental Health Disorder Status"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="survival_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>The Kaplan-Meier plot confirms our model findings - clients with
mental health disorders (blue line) have substantially better retention
over time compared to those without (red line). At 500 days,
approximately 40% of clients with mental health disorders remain in
treatment, compared to only about 20% of those without. The
non-overlapping confidence intervals indicate this difference is
statistically significant throughout the observation period.</p>
</div>
<div class="section level3">
<h3 id="time-varying-covariates-model">Time-Varying Covariates Model<a class="anchor" aria-label="anchor" href="#time-varying-covariates-model"></a>
</h3>
<p>The <code>segment_episodes_by_covars</code> function creates a
dataset where observations are split whenever a specified covariate
changes value. This allows us to incorporate time-varying covariates in
survival analysis.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">episodes_tv</span> <span class="op">&lt;-</span> <span class="va">substance_use</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/segment_episodes_by_covars.html">segment_episodes_by_covars</a></span><span class="op">(</span></span>
<span>    date_col <span class="op">=</span> <span class="va">visit_date</span>,</span>
<span>    covar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"frequency_of_use"</span>, <span class="st">"housing"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    gap_threshold <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    gap_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span>, <span class="va">episode_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_surv_time.html">add_surv_time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tv_model_result</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">start_time</span>, time2 <span class="op">=</span> <span class="va">end_time</span>, event <span class="op">=</span> <span class="va">discontinued</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">substance</span> <span class="op">+</span> <span class="va">medication</span> <span class="op">+</span> <span class="va">mental_health_disorder</span> <span class="op">+</span></span>
<span>      <span class="va">frequency_of_use</span> <span class="op">+</span> <span class="va">housing</span> <span class="op">+</span> <span class="va">died_ever</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">surv_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">episodes_tv</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, conf.level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tv_model_result</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 24 × 7</span></span></span>
<span><span class="co">#&gt;    term                estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> age                    1.00    8.45<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>     0.846  3.98<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.999     1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mental_health_diso…    0.678   2.41<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>   -<span style="color: #BB0000;">16.1</span>    1.90<span style="color: #949494;">e</span><span style="color: #BB0000;">-58</span>    0.647     0.711</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mental_health_diso…   <span style="color: #BB0000;">NA</span>       0   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> died_everTRUE          1.21    2.84<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>     6.73   1.67<span style="color: #949494;">e</span><span style="color: #BB0000;">-11</span>    1.14      1.28 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> `cluster(client_id…    1.00    7.96<span style="color: #949494;">e</span><span style="color: #BB0000;">-6</span>     0.367  7.13<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    1.00      1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> genderFemale           1.02    2.34<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>     1.00   3.17<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.978     1.07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> genderNon-binary       1.10    6.02<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>     1.52   1.29<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.974     1.23 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> raceBlack              1.02    3.28<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>     0.734  4.63<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.961     1.09 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> raceHispanic           0.991   3.28<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    -<span style="color: #BB0000;">0.289</span>  7.72<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.929     1.06 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> raceAsian              0.922   5.32<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>    -<span style="color: #BB0000;">1.53</span>   1.27<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.831     1.02 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 14 more rows</span></span></span></code></pre></div>
<div class="section level4">
<h4 id="interpreting-time-varying-results">Interpreting Time-Varying Results<a class="anchor" aria-label="anchor" href="#interpreting-time-varying-results"></a>
</h4>
<p>When we include time-varying covariates, we gain additional
insights:</p>
<ul>
<li>
<strong>Mental health disorder</strong> continues to show a strong
protective effect (HR = 0.678, 95% CI: 0.647-0.711), consistent with our
fixed-effects model.</li>
<li>
<strong>Housing status</strong> emerges as a significant predictor
(housing.L, HR = 1.62, 95% CI: 1.53-1.72), suggesting clients with
unstable housing have a 62% higher risk of discontinuation.</li>
<li>
<strong>Mortality risk</strong> shows a slightly attenuated effect
(HR = 1.21 vs. 1.40 in the fixed model), suggesting some of the
association is explained by time-varying factors.</li>
<li>
<strong>Substance type</strong>: Opiate use remains associated with
higher discontinuation risk (HR = 1.17, 95% CI: 1.07-1.27).</li>
<li>
<strong>Frequency of use</strong> shows no clear linear relationship
with retention.</li>
</ul>
<p>The time-varying model provides a more nuanced understanding of
retention dynamics, highlighting the importance of housing stability as
a key factor in treatment continuation.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="time-to-death-last-episode">Time to Death (Last Episode)<a class="anchor" aria-label="anchor" href="#time-to-death-last-episode"></a>
</h2>
<div class="section level3">
<h3 id="last-episode-analysis">Last Episode Analysis<a class="anchor" aria-label="anchor" href="#last-episode-analysis"></a>
</h3>
<p>We can also analyze time to death, focusing only on the last episode
for each client:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">episodes_fixed_death</span> <span class="op">&lt;-</span> <span class="va">substance_use</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/segment_episodes.html">segment_episodes</a></span><span class="op">(</span></span>
<span>    date_col <span class="op">=</span> <span class="va">visit_date</span>,</span>
<span>    gap_threshold <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    gap_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    episodes <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">death_model_result</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">episode_days</span>, <span class="va">died_ever</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">substance</span> <span class="op">+</span> <span class="va">medication</span> <span class="op">+</span> <span class="va">mental_health_disorder</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">surv_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">episodes_fixed_death</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, conf.level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">death_model_result</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 15 × 7</span></span></span>
<span><span class="co">#&gt;    term                estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> age                    1.00    0.002<span style="text-decoration: underline;">04</span>     1.56   1.20<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.999     1.01 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mental_health_diso…    0.405   0.056<span style="text-decoration: underline;">0</span>    -<span style="color: #BB0000;">16.1</span>    1.55<span style="color: #949494;">e</span><span style="color: #BB0000;">-58</span>    0.363     0.452</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mental_health_diso…   <span style="color: #BB0000;">NA</span>       0          <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> genderFemale           0.948   0.056<span style="text-decoration: underline;">3</span>     -<span style="color: #BB0000;">0.951</span>  3.42<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.849     1.06 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> genderNon-binary       1.06    0.143       0.389  6.98<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.799     1.40 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> raceBlack              1.10    0.078<span style="text-decoration: underline;">4</span>      1.16   2.47<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.939     1.28 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> raceHispanic           1.05    0.077<span style="text-decoration: underline;">8</span>      0.633  5.26<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.902     1.22 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> raceAsian              0.911   0.130      -<span style="color: #BB0000;">0.719</span>  4.72<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.705     1.18 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> raceOther              1.33    0.123       2.34   1.95<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    1.05      1.70 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> substanceOpiates       1.29    0.091<span style="text-decoration: underline;">8</span>      2.76   5.70<span style="color: #949494;">e</span><span style="color: #BB0000;">- 3</span>    1.08      1.54 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> medicationDisulfir…    0.900   0.109      -<span style="color: #BB0000;">0.968</span>  3.33<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.726     1.11 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> medicationAcampros…    0.853   0.100      -<span style="color: #BB0000;">1.59</span>   1.12<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.700     1.04 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> medicationNaltrexo…    0.859   0.089<span style="text-decoration: underline;">0</span>     -<span style="color: #BB0000;">1.70</span>   8.87<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    0.722     1.02 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> medicationMethadone    0.979   0.120      -<span style="color: #BB0000;">0.174</span>  8.62<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.773     1.24 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> medicationBuprenor…    0.904   0.116      -<span style="color: #BB0000;">0.869</span>  3.85<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.721     1.13</span></span></code></pre></div>
<div class="section level4">
<h4 id="interpreting-mortality-results">Interpreting Mortality Results<a class="anchor" aria-label="anchor" href="#interpreting-mortality-results"></a>
</h4>
<p>The mortality analysis reveals significant protective and risk
factors:</p>
<ul>
<li>
<strong>Mental health disorder</strong>: Strong protective
association with mortality (HR = 0.405, 95% CI: 0.363-0.452), suggesting
a 59.5% reduction in mortality risk for clients with mental health
disorders.</li>
<li>
<strong>Substance type</strong>: Opiate users have a 29% higher
mortality risk compared to alcohol users (HR = 1.29, 95% CI:
1.08-1.54).</li>
<li>
<strong>Race</strong>: “Other” race category shows elevated
mortality risk (HR = 1.33, 95% CI: 1.05-1.70).</li>
<li>
<strong>Medications</strong>: While not reaching statistical
significance at p&lt;0.05, there’s a trend toward protective effects for
several medications, particularly Acamprosate (HR = 0.853) and
Naltrexone (HR = 0.859).</li>
</ul>
<p>These findings highlight the complex relationship between mental
health comorbidity and substance use outcomes, with mental health
disorders associated with both better retention and lower mortality.</p>
</div>
</div>
<div class="section level3">
<h3 id="visualizing-survival-by-substance-type">Visualizing Survival by Substance Type<a class="anchor" aria-label="anchor" href="#visualizing-survival-by-substance-type"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_curves_substance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">episode_days</span>, <span class="va">died_ever</span><span class="op">)</span> <span class="op">~</span> <span class="va">substance</span>,</span>
<span>  data <span class="op">=</span> <span class="va">episodes_fixed_death</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/ggsurvfit.html" class="external-link">ggsurvfit</a></span><span class="op">(</span><span class="va">surv_curves_substance</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_confidence_interval.html" class="external-link">add_confidence_interval</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_risktable.html" class="external-link">add_risktable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Days"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Probability of Survival"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Kaplan-Meier Curves by Substance"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="survival_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The survival curves by substance type show that opiate users (red
line) have consistently worse survival outcomes compared to alcohol
users (blue line). The separation of curves begins early and widens over
time, with approximately 85% of alcohol users surviving to 1000 days
compared to only about 75% of opiate users. The risk table shows how the
number at risk decreases over time for both groups.</p>
</div>
<div class="section level3">
<h3 id="time-varying-death-analysis">Time-Varying Death Analysis<a class="anchor" aria-label="anchor" href="#time-varying-death-analysis"></a>
</h3>
<p>For a more nuanced analysis, we can incorporate time-varying
covariates:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">episodes_tv_death</span> <span class="op">&lt;-</span> <span class="va">substance_use</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/segment_episodes_by_covars.html">segment_episodes_by_covars</a></span><span class="op">(</span></span>
<span>    date_col <span class="op">=</span> <span class="va">visit_date</span>,</span>
<span>    covar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"died_last_visit"</span>, <span class="st">"frequency_of_use"</span>, <span class="st">"housing"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    gap_threshold <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    gap_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span>, <span class="va">episode_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_surv_time.html">add_surv_time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">death_tv_model</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">start_time</span>, time2 <span class="op">=</span> <span class="va">end_time</span>, event <span class="op">=</span> <span class="va">died_last_visit</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">substance</span> <span class="op">+</span> <span class="va">medication</span> <span class="op">+</span> <span class="va">mental_health_disorder</span> <span class="op">+</span></span>
<span>      <span class="va">frequency_of_use</span> <span class="op">+</span> <span class="va">housing</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">surv_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">episodes_tv_death</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, conf.level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">death_tv_model</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 23 × 7</span></span></span>
<span><span class="co">#&gt;    term                estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> age                    1.00  0.002<span style="text-decoration: underline;">04</span>      2.06    3.94<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    1.00      1.01 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mental_health_diso…    0.505 0.056<span style="text-decoration: underline;">5</span>     -<span style="color: #BB0000;">12.1</span>     1.45<span style="color: #949494;">e</span><span style="color: #BB0000;">-33</span>    0.452     0.565</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mental_health_diso…   <span style="color: #BB0000;">NA</span>     0           <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> `cluster(client_id…    1.00  0.000<span style="text-decoration: underline;">019</span>2   -<span style="color: #BB0000;">0.329</span>   7.42<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    1.00      1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> genderFemale           0.953 0.056<span style="text-decoration: underline;">4</span>      -<span style="color: #BB0000;">0.855</span>   3.93<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.853     1.06 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> genderNon-binary       0.987 0.143       -<span style="color: #BB0000;">0.090</span><span style="color: #BB0000; text-decoration: underline;">3</span>  9.28<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.745     1.31 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> raceBlack              1.08  0.078<span style="text-decoration: underline;">4</span>       1.01    3.15<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.928     1.26 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> raceHispanic           1.13  0.078<span style="text-decoration: underline;">1</span>       1.58    1.14<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.971     1.32 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> raceAsian              0.943 0.130       -<span style="color: #BB0000;">0.452</span>   6.51<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.730     1.22 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> raceOther              1.25  0.124        1.80    7.25<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    0.980     1.59 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 13 more rows</span></span></span></code></pre></div>
<div class="section level4">
<h4 id="interpreting-time-varying-mortality-results">Interpreting Time-Varying Mortality Results<a class="anchor" aria-label="anchor" href="#interpreting-time-varying-mortality-results"></a>
</h4>
<p>The time-varying mortality model reveals additional important
factors:</p>
<ul>
<li>
<strong>Housing status</strong> emerges as the strongest predictor
(housing.L, HR = 3.25, 95% CI: 2.91-3.62), indicating that unstable
housing is associated with more than three times the risk of
mortality.</li>
<li>
<strong>Substance type</strong>: Opiate use shows an even stronger
association with mortality (HR = 2.11, 95% CI: 1.76-2.53) than in the
fixed model.</li>
<li>
<strong>Mental health disorder</strong> remains strongly protective
(HR = 0.505, 95% CI: 0.452-0.565).</li>
<li>
<strong>Frequency of use</strong> shows a complex non-linear
relationship with mortality (both linear and quadratic terms
significant).</li>
<li>
<strong>Naltrexone</strong> emerges as significantly protective (HR
= 0.812, 95% CI: 0.681-0.968), suggesting a 18.8% reduction in mortality
risk.</li>
<li>
<strong>Age</strong> becomes marginally significant (HR = 1.00, p =
0.039), suggesting a small increase in mortality risk with age.</li>
</ul>
<p>The time-varying model highlights how critical social determinants of
health (housing) and current use patterns are in predicting mortality
risk beyond static client characteristics.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="time-to-death-all-episodes">Time to Death (All Episodes)<a class="anchor" aria-label="anchor" href="#time-to-death-all-episodes"></a>
</h2>
<div class="section level3">
<h3 id="basic-model-with-clustering">Basic Model with Clustering<a class="anchor" aria-label="anchor" href="#basic-model-with-clustering"></a>
</h3>
<p>When analyzing data across all episodes for each client, we use
clustering to account for within-client correlation:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">episodes_clustered</span> <span class="op">&lt;-</span> <span class="va">substance_use</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/segment_episodes_by_covars.html">segment_episodes_by_covars</a></span><span class="op">(</span></span>
<span>    date_col <span class="op">=</span> <span class="va">visit_date</span>,</span>
<span>    covar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"died_last_visit"</span><span class="op">)</span>,</span>
<span>    gap_threshold <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    gap_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span>, <span class="va">episode_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_surv_time.html">add_surv_time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clustered_model</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">start_time</span>, time2 <span class="op">=</span> <span class="va">end_time</span>, event <span class="op">=</span> <span class="va">died_last_visit</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">substance</span> <span class="op">+</span> <span class="va">medication</span> <span class="op">+</span> <span class="va">mental_health_disorder</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">surv_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">episodes_clustered</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, conf.level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clustered_model</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 16 × 7</span></span></span>
<span><span class="co">#&gt;    term                estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> age                    1.00  0.002<span style="text-decoration: underline;">02</span>     1.49     1.36<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.999     1.01 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mental_health_diso…    0.471 0.056<span style="text-decoration: underline;">6</span>    -<span style="color: #BB0000;">13.3</span>      1.75<span style="color: #949494;">e</span><span style="color: #BB0000;">-40</span>    0.421     0.526</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mental_health_diso…   <span style="color: #BB0000;">NA</span>     0          <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> `cluster(client_id…    1.00  0.000<span style="text-decoration: underline;">019</span>2   0.006<span style="text-decoration: underline;">88</span>  9.95<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    1.00      1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> genderFemale           0.958 0.056<span style="text-decoration: underline;">3</span>     -<span style="color: #BB0000;">0.763</span>    4.45<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.858     1.07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> genderNon-binary       1.06  0.143       0.428    6.69<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.803     1.41 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> raceBlack              1.10  0.078<span style="text-decoration: underline;">4</span>      1.24     2.16<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.945     1.28 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> raceHispanic           1.08  0.077<span style="text-decoration: underline;">9</span>      1.01     3.12<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.929     1.26 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> raceAsian              0.942 0.130      -<span style="color: #BB0000;">0.455</span>    6.49<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.730     1.22 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> raceOther              1.33  0.123       2.31     2.08<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    1.04      1.69 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> substanceOpiates       2.21  0.092<span style="text-decoration: underline;">0</span>      8.60     7.88<span style="color: #949494;">e</span><span style="color: #BB0000;">-18</span>    1.84      2.64 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> medicationDisulfir…    0.851 0.109      -<span style="color: #BB0000;">1.48</span>     1.39<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.687     1.05 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> medicationAcampros…    0.811 0.100      -<span style="color: #BB0000;">2.08</span>     3.76<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    0.666     0.988</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> medicationNaltrexo…    0.823 0.089<span style="text-decoration: underline;">1</span>     -<span style="color: #BB0000;">2.18</span>     2.89<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    0.691     0.980</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> medicationMethadone    0.917 0.120      -<span style="color: #BB0000;">0.721</span>    4.71<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.724     1.16 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> medicationBuprenor…    0.867 0.115      -<span style="color: #BB0000;">1.23</span>     2.17<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.692     1.09</span></span></code></pre></div>
<div class="section level4">
<h4 id="interpreting-clustered-results">Interpreting Clustered Results<a class="anchor" aria-label="anchor" href="#interpreting-clustered-results"></a>
</h4>
<p>When analyzing mortality across all episodes with clustering:</p>
<ul>
<li>
<strong>Mental health disorder</strong> maintains its protective
association (HR = 0.471, 95% CI: 0.421-0.526).</li>
<li>
<strong>Substance type</strong>: Opiate use shows a strong
association with mortality (HR = 2.21, 95% CI: 1.84-2.64).</li>
<li>
<strong>Medications</strong>: Both Acamprosate (HR = 0.811, 95% CI:
0.666-0.988) and Naltrexone (HR = 0.823, 95% CI: 0.691-0.980) show
statistically significant protective effects.</li>
<li>
<strong>Race</strong>: The “Other” race category continues to show
elevated risk (HR = 1.33, 95% CI: 1.04-1.69).</li>
</ul>
<p>By accounting for within-client correlation using the
<code><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster()</a></code> function, we ensure that standard errors are
appropriately adjusted for repeated observations from the same
clients.</p>
</div>
</div>
<div class="section level3">
<h3 id="comprehensive-model">Comprehensive Model<a class="anchor" aria-label="anchor" href="#comprehensive-model"></a>
</h3>
<p>Finally, we build a more comprehensive model with all available
time-varying covariates:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">episodes_comprehensive</span> <span class="op">&lt;-</span> <span class="va">substance_use</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/segment_episodes_by_covars.html">segment_episodes_by_covars</a></span><span class="op">(</span></span>
<span>    date_col <span class="op">=</span> <span class="va">visit_date</span>,</span>
<span>    covar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"died_last_visit"</span>, <span class="st">"discontinued"</span>, <span class="st">"frequency_of_use"</span>, <span class="st">"housing"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    gap_threshold <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    gap_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">client_id</span>, <span class="va">episode_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_surv_time.html">add_surv_time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comprehensive_model</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">start_time</span>, time2 <span class="op">=</span> <span class="va">end_time</span>, event <span class="op">=</span> <span class="va">died_last_visit</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">substance</span> <span class="op">+</span> <span class="va">medication</span> <span class="op">+</span> <span class="va">mental_health_disorder</span> <span class="op">+</span></span>
<span>      <span class="va">frequency_of_use</span> <span class="op">+</span> <span class="va">housing</span> <span class="op">+</span> <span class="va">discontinued</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">surv_spec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">episodes_comprehensive</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, conf.level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comprehensive_model</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 24 × 7</span></span></span>
<span><span class="co">#&gt;    term                estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> age                    1.00  0.002<span style="text-decoration: underline;">04</span>       1.70   8.92<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span>    0.999     1.01 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mental_health_diso…    0.573 0.057<span style="text-decoration: underline;">0</span>       -<span style="color: #BB0000;">9.77</span>   1.56<span style="color: #949494;">e</span><span style="color: #BB0000;">-22</span>    0.513     0.641</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mental_health_diso…   <span style="color: #BB0000;">NA</span>     0            <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>   <span style="color: #949494;"> </span>      <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> discontinuedTRUE       2.98  0.058<span style="text-decoration: underline;">2</span>       18.8    1.71<span style="color: #949494;">e</span><span style="color: #BB0000;">-78</span>    2.66      3.34 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> `cluster(client_id…    1.00  0.000<span style="text-decoration: underline;">019</span>3    -<span style="color: #BB0000;">1.06</span>   2.91<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    1.00      1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> genderFemale           0.932 0.056<span style="text-decoration: underline;">4</span>       -<span style="color: #BB0000;">1.26</span>   2.09<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.834     1.04 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> genderNon-binary       0.971 0.143        -<span style="color: #BB0000;">0.203</span>  8.39<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.733     1.29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> raceBlack              1.04  0.078<span style="text-decoration: underline;">5</span>        0.534  5.93<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.894     1.22 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> raceHispanic           1.12  0.078<span style="text-decoration: underline;">0</span>        1.49   1.37<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.964     1.31 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> raceAsian              0.953 0.130        -<span style="color: #BB0000;">0.367</span>  7.14<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span>    0.738     1.23 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 14 more rows</span></span></span></code></pre></div>
<div class="section level4">
<h4 id="interpreting-the-comprehensive-model">Interpreting the Comprehensive Model<a class="anchor" aria-label="anchor" href="#interpreting-the-comprehensive-model"></a>
</h4>
<p>The fully specified model reveals the most complete picture of
mortality risk factors:</p>
<ul>
<li>
<strong>Treatment discontinuation</strong> is a major risk factor
(HR = 2.98, 95% CI: 2.66-3.34), with clients who discontinue treatment
having nearly three times the mortality risk.</li>
<li>
<strong>Housing instability</strong> remains a strong predictor
(housing.L, HR = 2.77, 95% CI: 2.48-3.09), even after controlling for
other factors.</li>
<li>
<strong>Substance type</strong>: Opiate use continues to show
elevated risk (HR = 2.22, 95% CI: 1.85-2.66).</li>
<li>
<strong>Mental health disorder</strong> maintains its protective
association (HR = 0.573, 95% CI: 0.513-0.641), though the effect size is
somewhat attenuated in this full model.</li>
<li>
<strong>Frequency of use</strong> shows both linear (HR = 1.18, 95%
CI: 1.02-1.37) and quadratic (HR = 1.34, 95% CI: 1.16-1.55)
relationships with mortality.</li>
<li>
<strong>Naltrexone</strong> continues to show a protective effect
(HR = 0.822, 95% CI: 0.690-0.980).</li>
</ul>
<p>This comprehensive model highlights the critical interplay between
treatment retention, social determinants (housing), substance type, and
medication in determining mortality outcomes. The finding that treatment
discontinuation is associated with nearly three times the mortality risk
underscores the life-saving potential of effective retention
strategies.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<p>Keep in mind that these are simple Cox models to inspire users of
{episodes} to see how easy it is to get started running survival
analyses. Additionally, we are not testing any of the assumptions,
mainly the proportional hazards assumption.</p>
<p>Some limitations to consider:</p>
<ol style="list-style-type: decimal">
<li><p>The proportional hazards assumption should be verified using
tests like Schoenfeld residuals (<code><a href="https://rdrr.io/pkg/survival/man/cox.zph.html" class="external-link">cox.zph()</a></code> in the
{survival} package)</p></li>
<li><p>Recurrent events are treated independently, ignoring temporal
ordering effects</p></li>
<li><p>Competing risks and multiple states (discontinuation and death)
are not accounted for, which may lead to biased estimates</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="r-package-suggestions">R Package Suggestions<a class="anchor" aria-label="anchor" href="#r-package-suggestions"></a>
</h2>
<p>If you’re interested in exploring more complex modeling approaches,
you could consider:</p>
<div class="section level3">
<h3 id="for-cox-models">For Cox Models<a class="anchor" aria-label="anchor" href="#for-cox-models"></a>
</h3>
<ul>
<li><p>{survival}: The foundation for survival analysis in R with
functions for Cox regression, Kaplan-Meier curves, and
diagnostics</p></li>
<li><p>{survminer}: Enhanced visualization of survival analyses</p></li>
<li><p>{coxme}: Mixed-effects Cox models for clustered/grouped
data</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="more-complex-models">More Complex Models<a class="anchor" aria-label="anchor" href="#more-complex-models"></a>
</h3>
<ul>
<li><p>{cmprsk} or {riskRegression}: Competing risks analysis</p></li>
<li><p>{frailtypack}: Joint frailty models for recurrent events and
terminal events</p></li>
<li><p>{msm}: Multi-state models for transitions between states</p></li>
<li><p>{mstate}: Multi-state modeling with the Cox proportional hazards
model</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="assumptions-testing">Assumptions Testing<a class="anchor" aria-label="anchor" href="#assumptions-testing"></a>
</h3>
<ul>
<li><p>{flexsurv}: Flexible parametric survival models</p></li>
<li><p>{timereg}: For non-proportional hazards models</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="bayesian-approaches">Bayesian Approaches<a class="anchor" aria-label="anchor" href="#bayesian-approaches"></a>
</h3>
<ul>
<li><p>{rstanarm}: Bayesian survival models using Stan</p></li>
<li><p>{brms}: Flexible Bayesian regression models including survival
models</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>The {episodes} package provides powerful tools for analyzing
longitudinal health data:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/segment_episodes.html">segment_episodes()</a></code> creates episode-level datasets based
on temporal gaps</li>
<li>
<code><a href="../reference/segment_episodes_by_covars.html">segment_episodes_by_covars()</a></code> allows for time-varying
covariate analysis</li>
<li>
<code><a href="../reference/add_surv_time.html">add_surv_time()</a></code> prepares data for survival
analysis</li>
</ol>
<p>These functions integrate seamlessly with {tidymodels} and survival
analysis workflows, enabling sophisticated analyses of treatment
patterns, outcomes, and risk factors.</p>
<p>By segmenting longitudinal data into meaningful episodes and
incorporating time-varying covariates, researchers can gain deeper
insights into the complex dynamics of substance use treatment
outcomes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dylan Pieper.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
